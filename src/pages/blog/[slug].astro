---
import { NostrComments } from "../../components/NostrComments";
import ArticleMeta from "../../components/blog/ArticleMeta.astro";
import TableOfContents from "../../components/blog/TableOfContents.astro";
import BlogLayout from "../../layouts/BlogLayout.astro";
import { blogPosts } from "../../lib/blog.tsx";

export function getStaticPaths() {
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { slug } = Astro.params;
const post = blogPosts.find((p) => p.slug === slug);

if (!post) {
  throw new Error(`Blog post not found: ${slug}`);
}

const { frontmatter, Content } = post;
---

<BlogLayout title={frontmatter.title} description={frontmatter.description}>
  <article class="py-20 bg-bg-secondary min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col lg:flex-row lg:gap-12">
        <!-- 左侧目录 -->
        <aside class="hidden lg:block w-56 shrink-0">
          <div class="sticky top-24">
            <a
              onclick={`history.go(-1)`}
              class="inline-flex items-center cursor-pointer text-primary-600 dark:text-primary-400 hover:underline mb-6 text-sm transition-colors"
            >
              ← 返回
            </a>
            <TableOfContents />
          </div>
        </aside>

        <!-- 主内容区域 -->
        <div class="flex-1 max-w-3xl">
          <a
            onclick={`history.go(-1)`}
            class="lg:hidden inline-flex items-center cursor-pointer text-primary-600 dark:text-primary-400 hover:underline mb-8 transition-colors"
          >
            ← 返回
          </a>

          <header class="mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-text-primary mb-4">
              {frontmatter.title}
            </h1>
            <ArticleMeta
              authors={frontmatter.authors}
              date={frontmatter.date}
              tags={frontmatter.tags}
            />
          </header>

          <div class="prose prose-slate dark:prose-invert max-w-none">
            <Content />
          </div>

          <div class="h-6 w-full"></div>

          {/* Nostr 评论区 */}
          <NostrComments
            articleSlug={slug}
            articleAuthorPubkeys={frontmatter.authors
              .map((author) =>
                typeof author === "string" ? undefined : author.pubkey
              )
              .filter(Boolean) as string[]}
            client:visible
          />
        </div>
      </div>
    </div>
  </article>
</BlogLayout>
