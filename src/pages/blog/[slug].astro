---
import { undefined } from "astro:schema";
import { NostrComments } from "../../components/NostrComments";
import BlogLayout from "../../layouts/BlogLayout.astro";
import { blogPosts } from "../../lib/blog.tsx";
import { getNostrProfileUrl } from "../../lib/nostr";

export function getStaticPaths() {
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { slug } = Astro.params;
const post = blogPosts.find((p) => p.slug === slug);

if (!post) {
  throw new Error(`Blog post not found: ${slug}`);
}

const { frontmatter, Content } = post;
---

<BlogLayout title={frontmatter.title} description={frontmatter.description}>
  <article class="py-20 bg-slate-50 dark:bg-slate-800 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col lg:flex-row lg:gap-12">
        <!-- 左侧提纲 -->
        <aside class="hidden lg:block w-56 shrink-0">
          <div class="sticky top-24">
            <a
              onclick={`history.go(-1)`}
              class="inline-flex items-center cursor-pointer text-purple-600 dark:text-purple-400 hover:underline mb-6 text-sm"
            >
              ← 返回
            </a>
            <nav id="toc">
              <ul
                id="toc-list"
                class="space-y-2 text-sm border-l border-slate-200 dark:border-slate-700"
              >
                <!-- TOC items will be generated by JavaScript -->
              </ul>
            </nav>
          </div>
        </aside>

        <!-- 主内容区域 -->
        <div class="flex-1 max-w-3xl">
          <a
            onclick={`history.go(-1)`}
            class="lg:hidden inline-flex items-center cursor-pointer text-purple-600 dark:text-purple-400 hover:underline mb-8"
          >
            ← 返回
          </a>

          <header class="mb-4">
            <h1 class="text-4xl font-bold text-slate-900 dark:text-white mb-4">
              {frontmatter.title}
            </h1>
            <div
              class="flex flex-wrap items-center gap-2 text-sm text-slate-500 dark:text-slate-400"
            >
              {
                frontmatter.authors.map((author, index) => {
                  const { name, pubkey } =
                    typeof author === "string" ? { name: author } : author;
                  return (
                    <>
                      {pubkey ? (
                        <a
                          href={getNostrProfileUrl(pubkey)}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="hover:underline"
                        >
                          {name}
                        </a>
                      ) : (
                        <span>{name}</span>
                      )}
                      {index < frontmatter.authors.length - 1 && <span>&</span>}
                    </>
                  );
                })
              }
              <span>•</span>
              <time datetime={frontmatter.date}>
                {
                  new Date(frontmatter.date).toLocaleDateString("zh-CN", {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                  })
                }
              </time>
            </div>
            {
              frontmatter.tags && frontmatter.tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mt-4">
                  {frontmatter.tags.map((tag: string) => (
                    <span class="px-3 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 text-sm rounded-full">
                      {tag}
                    </span>
                  ))}
                </div>
              )
            }
          </header>

          <div class="prose prose-slate dark:prose-invert max-w-none">
            <Content />
          </div>

          <div class="h-6 w-full"></div>

          {/* Nostr 评论区 */}
          <NostrComments
            articleSlug={slug}
            articleAuthorPubkeys={frontmatter.authors
              .map((author) =>
                typeof author === "string" ? undefined : author.pubkey
              )
              .filter(Boolean) as string[]}
            client:visible
          />
        </div>
      </div>
    </div>
  </article>
</BlogLayout>

<script>
  function generateTOC() {
    const article = document.querySelector(".prose");
    const tocList = document.getElementById("toc-list");

    if (!article || !tocList) return;

    const headings = article.querySelectorAll("h2, h3");

    if (headings.length === 0) {
      const toc = document.getElementById("toc");
      if (toc) toc.style.display = "none";
      return;
    }

    // 点击锁定，防止 observer 覆盖
    let isClickLocked = false;

    // 高亮函数
    function setActiveLink(id: string) {
      if (!tocList) return;

      tocList.querySelectorAll("a").forEach((a) => {
        a.classList.remove(
          "text-purple-600",
          "dark:text-purple-400",
          "border-purple-500",
          "font-medium"
        );
        a.classList.add(
          "text-slate-500",
          "dark:text-slate-400",
          "border-transparent"
        );
      });
      const activeLink = tocList.querySelector(`a[href="#${id}"]`);
      if (activeLink) {
        activeLink.classList.remove(
          "text-slate-500",
          "dark:text-slate-400",
          "border-transparent",
          "hover:text-slate-900",
          "dark:hover:text-white",
          "hover:border-slate-400",
          "dark:hover:border-slate-500"
        );
        activeLink.classList.add(
          "text-purple-600",
          "dark:text-purple-400",
          "border-purple-500",
          "hover:text-purple-600",
          "dark:hover:text-purple-400",
          "hover:border-purple-500",
          "font-medium"
        );
      }
    }

    headings.forEach((heading, index) => {
      // 为标题添加 id
      if (!heading.id) {
        heading.id = `heading-${index}`;
      }

      const li = document.createElement("li");
      li.className = "-ml-px";
      const a = document.createElement("a");
      a.href = `#${heading.id}`;
      a.textContent = heading.textContent;
      a.className = `block py-1 pl-4 border-l-2 border-transparent text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white hover:border-slate-400 dark:hover:border-slate-500 transition-colors ${
        heading.tagName === "H3" ? "pl-6 text-[13px]" : ""
      }`;

      // 点击时立即高亮，并锁定一段时间
      a.addEventListener("click", () => {
        isClickLocked = true;
        setActiveLink(heading.id);
        // 等待滚动完成后解锁
        setTimeout(() => {
          isClickLocked = false;
        }, 1000);
      });

      li.appendChild(a);
      tocList.appendChild(li);
    });

    // 高亮当前阅读的章节 - 使用滚动事件
    function updateActiveHeading() {
      if (isClickLocked) return;

      const scrollTop = window.scrollY;
      let currentHeading = null;

      for (const heading of headings) {
        const rect = heading.getBoundingClientRect();
        // 标题距离顶部 100px 以内时认为是当前章节
        if (rect.top <= 100) {
          currentHeading = heading;
        }
      }

      if (currentHeading) {
        setActiveLink(currentHeading.id);
      }
    }

    window.addEventListener("scroll", updateActiveHeading, { passive: true });
    updateActiveHeading();
  }

  document.addEventListener("DOMContentLoaded", generateTOC);
  document.addEventListener("astro:page-load", generateTOC);
</script>
